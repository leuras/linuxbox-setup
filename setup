#!/bin/bash

__BASE_DIR=$(dirname "$0")
__JSON_PACKAGES=$(cat package.json)

# import functions definition and variables
. $__BASE_DIR/lib/json.sh
. $__BASE_DIR/lib/installer.sh

function main {

    install_required_packages
    
    for group in $(package_groups); do
        echo "Working on ${group} ..."

        case "${group}" in 
            "packages")
                # install_standalone_packages
            ;;
            "custom-ppa-repositories")
                install_from_custom_ppa_repositories
            ;;
        esac
    done

    # clean up
    cleanup_installation
}

function install_required_packages {
    apt update && apt install -y \
        wget \
        curl \
        jq \
        zip \
        gdebi \
        apt-transport-https \
        ca-certificates \
        software-properties-common \
        lsb-release \
        vim \
        zsh \
        fzf \
        tilix \
        openjdk-11-jdk \
        python3 \
        python3-pip \
        python3-venv \
        flameshot
}

function package_groups {
    local groups_array=$(json_keys "${__JSON_PACKAGES}")
    
    echo "$(json_array_to_string_list "${groups_array}")"
}

function install_standalone_packages {
    local packages_array=$(json_keys "${__JSON_PACKAGES}" ".packages")
    local packages=$(json_array_to_string_list "${packages_array}")

    for package in $packages; do
        local properties=$(json_value "${__JSON_PACKAGES}" ".packages.${package}")

        echo "Installing package ${package} ..."
        install_package "${package}" "${properties}"

        echo "Done"
        echo ""
    done
}

function install_from_custom_ppa_repositories {
    local packages_array=$(json_keys "${__JSON_PACKAGES}" ".custom-ppa-repositories")
    local packages=$(json_array_to_string_list "${packages_array}")

    for package in $packages; do
        local properties=$(json_value "${__JSON_PACKAGES}" ".custom-ppa-repositories.${package}")

        echo "Adding PPA repository for ${package} ..."
        add_custom_ppa "${package}" "${properties}"
        echo ""
    done

    apt update && apt install -y $packages
}

main
